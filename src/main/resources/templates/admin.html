<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title>Admin</title>
    <!-- Font Awesome -->
    <link th:href="@{https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css}" rel="stylesheet" />
    <!-- Google Fonts -->
    <link th:href="@{https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap}" rel="stylesheet" />
    <!-- MDB -->
    <link th:href="@{https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/7.2.0/mdb.min.css}" rel="stylesheet" />
    <!--  CSS -->
    <link th:href="@{/css/style.css}" rel="stylesheet" />
</head>

<body>
<div>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-body-tertiary">
        <!-- Container wrapper -->
        <div class="container-fluid">
            <!-- Toggle button -->
            <button data-mdb-collapse-init class="navbar-toggler" type="button"
                    data-mdb-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                    aria-expanded="false" aria-label="Toggle navigation">
                <i class="fas fa-bars"></i>
            </button>

            <!-- Collapsible wrapper -->
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <!-- Navbar brand -->
                <a class="navbar-brand mt-2 mt-lg-0" href="#">
                    <img src="https://mdbcdn.b-cdn.net/img/logo/mdb-transaprent-noshadows.webp" height="15"
                         alt="MDB Logo" loading="lazy" />
                </a>
                <!-- Left links -->
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{admin}" href="#">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" th:href="@{admin-thanhvien}">Thành viên</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" th:href="@{admin-thietbi}">Thiết bị</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" th:href="@{admin-vipham}">Vi phạm</a>
                    </li>
                </ul>
                <!-- Left links -->
            </div>
            <!-- Collapsible wrapper -->

            <!-- Right elements -->
            <div class="d-flex align-items-center">
                <!-- Avatar -->
                <div class="dropdown">
                    <a data-mdb-dropdown-init class="dropdown-toggle d-flex align-items-center hidden-arrow"
                       href="#" id="navbarDropdownMenuAvatar" role="button" aria-expanded="false">
                        <img src="https://mdbcdn.b-cdn.net/img/new/avatars/2.webp" class="rounded-circle"
                             height="25" alt="Black and White Portrait of a Man" loading="lazy" />
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownMenuAvatar">
                        <li>
                            <a class="dropdown-item" href="#">My profile</a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="#">Settings</a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="#">Logout</a>
                        </li>
                    </ul>
                </div>
            </div>
            <!-- Right elements -->
        </div>
        <!-- Container wrapper -->
    </nav>
    <!-- Navbar -->
</div>
<div style="background-color: #eaeaea;">
    <!--        Thống kê thiết bị -->
    <div class="col-lg-8 col-md-6 mb-md-0 mb-4"
         style="width: 96%; margin-left: 2%;margin-bottom: 10px; margin-top: 10px;">
        <div class="card" style="height: 500px; overflow-y: scroll;scrollbar-width: none; scroll-margin: 1px;">
            <div class="card-body px-0 pb-2">
                <div style="display: flex;justify-content: space-between;padding: 5px;">
                    <span style="font-size: 20px;font-weight: bold;">Thiết bị</span>
                    <div style="display: flex; width: 64%; height: 35px;">
                        <select class="form-select me-3" id="statusSelect">
                            <option>Tất cả</option>
                            <option>Đang mượn</option>
                            <option>Chưa mượn</option>
                        </select>

                        <select class="form-select" id="monthSelect">
                            <option value="0">Tất cả</option>
                            <option value="1">Tháng 1</option>
                            <option value="2">Tháng 2</option>
                            <option value="3">Tháng 3</option>
                            <option value="4">Tháng 4</option>
                            <option value="5">Tháng 5</option>
                            <option value="6">Tháng 6</option>
                            <option value="7">Tháng 7</option>
                            <option value="8">Tháng 8</option>
                            <option value="9">Tháng 9</option>
                            <option value="10">Tháng 10</option>
                            <option value="11">Tháng 11</option>
                            <option value="12">Tháng 12</option>
                        </select>
                    </div>
                </div>
                <table class="table align-items-center mb-0">
                    <thead>
                    <tr>
                        <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                            Mã thiết bị</th>
                        <th
                                class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">
                            Tên</th>
                        <th
                                class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                            Mô tả</th>
                        <th
                                class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                            Trạng thái</th>
                         <th
                                    class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                                Mã sinh viên</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td>
                            <div class="d-flex px-2 py-1">
                                <div class="d-flex flex-column justify-content-center">
                                    <h6 class="mb-0 text-sm">01</h6>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="avatar-group mt-2">
                                Thiết bị A
                            </div>
                        </td>
                        <td class="align-middle text-center text-sm">
                            Được làm băng nhôm
                        </td>
                        <td class="align-middle text-center text-sm">
                            Được được mượn
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <!--        Thống kê thiết bị -->

    <!--        Thống kê vào khu học tập -->
    <div class="col-lg-8 col-md-6 mb-md-0 mb-4"
         style="width: 96%; margin-left: 2%;margin-bottom: 10px; margin-top: 10px;">
        <div class="card" style="height: 700px; overflow-y: scroll;scrollbar-width: none; scroll-margin: 1px;">
            <div class="card-body px-0 pb-2">
                <span style="font-size: 20px;font-weight: bold;">Thông tin sử dụng</span>

                <div class="row">
                    <div class="col-6">
                        <div class="d-flex flex-column">

                            <div class="mt-3 px-5">
                                <div class="input-group mb-3">
                                    <label class="input-group-text" for="enterFromDate">Từ</label>
                                    <input id="enterFromDate" class="form-control" type="datetime-local" min="" />

                                    <label class="input-group-text" for="enterToDate">Đến</label>
                                    <input id="enterToDate" class="form-control" type="datetime-local" min="" />
                                </div>
                            </div>

                            <div class="my-3 px-5">
                                <div data-mdb-input-init class="form-outline mb-4">
                                    <input type="text" name="input-khoa" id="input-khoa" class="form-control" />
                                    <label class="form-label" for="input-khoa">Khoa</label>
                                </div>

                                <div data-mdb-input-init class="form-outline mb-4">
                                    <input type="text" name="input-nganh" id="input-nganh" class="form-control" />
                                    <label class="form-label" for="input-nganh">Ngành</label>
                                </div>
                            </div>

                            <div class="row mb-3 px-5">
                                <div class="col-3">
                                    <button type="button" id="locVaoKhuHocTap" class=" btn btn-outline-primary"
                                            data-mdb-ripple-init data-mdb-ripple-color="dark">
                                        Lọc
                                    </button>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="table-responsive col-6">
                        <table class="table align-items-center mb-0">
                            <thead>
                            <tr>
                                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                                    Mã thành viên</th>
                                <th
                                        class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">
                                    Tên thành viên</th>
                                <th
                                        class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                                    Thời gian vào</th>
                            </tr>
                            </thead>
                            <tbody id="checkInList">
                            <tr th:each="checkIn : ${checkInList}">
                                <td th:text="${checkIn.thanhvien}"></td>
                                <td th:text="${checkIn.member.hoTen}"></td>
                                <td class="align-middle text-center text-sm" th:text="${checkIn.TGVao}"></td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-6">
                        <div style="display: flex;flex-direction: column;align-items: center">
                            <span style="font-size: 19px;font-weight: bold; color: #614cd7;">Số lượng thành viên</span>
                            <div style="height: 90px;width: 90px;border-radius: 90px;background-color: #05ad8d;display: flex;justify-content: center;align-items: center; font-size: 19px; margin: 10px;font-weight: bold;" th:text="${totalMember}">
                            </div>
                            <span style="font-size: 17px; color: #046b58;" th:text="'Tổng lượt thành viên vào: ' + ${totalMemberWithTGVao}"></span>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    <!--        Thống kê vào khu học tập -->


    <!--        Thống kê vi phạm -->
    <div class="col-lg-8 col-md-6 mb-md-0 mb-4"
         style="width: 96%; margin-left: 2%;margin-bottom: 10px;margin-top: 10px;">
        <div class="card"
             style="height: 500px; overflow-y: scroll;scrollbar-width: none; scroll-margin: 1px;margin-bottom: 15px;">
            <div class="card-body px-0 pb-2">
                <div style="display: flex;justify-content: space-between;padding: 5px;">
                    <span style="font-size: 20px;font-weight: bold;">Vi phạm</span>
                    <div style="display: flex; width: 40%; height: 35px;">
                        <select class="form-select" id="filterStatus">
                            <option>Tất cả</option>
                            <option>Đang xử lý</option>
                            <option>Đã xử lý</option>
                        </select>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table align-items-center mb-0">
                        <thead>
                        <tr>
                            <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                                Mã thành viên</th>
                            <th
                                    class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">
                                Tên thành viên</th>
                            <th
                                    class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                                Hình thức xử lý</th>
                            <th
                                    class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                                Số tiền</th>
                            <th
                                    class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                                Ngày xử lý</th>
                            <th
                                    class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                                Trạng thái</th>
                        </tr>
                        </thead>
                        <tbody id="xuLyList">
                        </tbody>
                    </table>

                    <div class="d-flex flex-column align-items-center mt-5">
                            <span style="    font-size: 19px;font-weight: bold; color: #614cd7;">Tổng số tiền bồi
                                thường</span>
                        <div
                                style="height: 90px;width: 90px;border-radius: 90px;background-color: #05ad8d;display: flex;justify-content: center;align-items: center; font-size: 19px; margin: 10px;font-weight: bold;" id="totalPrice">
                            5</div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    <!--        Thống kê vi phạm -->

</div>
</body>
<!-- MDB -->
<script type="text/javascript"
        th:src="@{https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/7.2.0/mdb.umd.min.js}"></script>
<script>
    document.getElementById("locVaoKhuHocTap").addEventListener("click", function () {
        var fromDate = document.getElementById("enterFromDate").value;
        var toDate = document.getElementById("enterToDate").value;
        var khoa = document.getElementById("input-khoa").value;
        var nganh = document.getElementById("input-nganh").value;

        var fromDateTime = fromDate.replace("T", " ");
        var toDateTime = toDate.replace("T", " ");

        var data = {
            fromDate: fromDateTime,
            toDate: toDateTime,
            khoa: khoa,
            nganh: nganh
        };

        fetch("/searchCheckIn", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
        })
            .then((res) => res.json())
            .then((data) => {
                if(data.success === false) {
                    alert(data.message);
                }else {
                    document.getElementById('checkInList').innerHTML = '';

                    data.result.forEach(function (info) {
                        var tr = document.createElement('tr');

                        var currentDate = new Date(info.tgvao);
                        currentDate.setHours(currentDate.getHours() + 7);
                        var formattedDate = currentDate.toISOString().slice(0, 19).replace('T', ' ');
                        tr.innerHTML = `
                                <td>${info.thanhvien}</td>
                                <td>${info.member.hoTen}</td>
                                <td class="align-middle text-center text-sm">${formattedDate}</td>
                            `;
                        document.getElementById('checkInList').appendChild(tr);
                    });
                }
            })
            .catch((error) => {
                console.log("error: " + error);
            });
    });
var devices = [];

fetch('/getDeviceAvailability', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    }
})
.then(response => response.json())
.then(data => {
    devices = data.devices;
    var tbody = document.querySelector('table tbody');
    tbody.innerHTML = '';

    devices.forEach(function(device) {
        var tr = document.createElement('tr');
        tr.innerHTML = '<td>' + device.maTB + '</td>' +
                       '<td>' + device.name + '</td>' +
                       '<td>' + device.description + '</td>' +
                       '<td>' + device.availability + '</td>' +
                          '<td>' + device.studentId + '</td>';
        tbody.appendChild(tr);
    });
})
.catch((error) => {
    console.error('Error:', error);
});

var statusSelect = document.getElementById('statusSelect');
var monthSelect = document.getElementById('monthSelect');

statusSelect.addEventListener('change', updateTable);
monthSelect.addEventListener('change', updateTable);

function updateTable() {
    var status = statusSelect.value;
    var month = monthSelect.value;

    var filteredDevices = devices.filter(function(device) {
        if (status === 'Tất cả') {
            return true;
        } else if (status === 'Đang mượn') {
            return device.availability === 'Đang mượn';
        } else {
            return device.availability === 'Chưa mượn';
        }
    });

    //after filtering by status, filter by month:
    if (month !== '0') {
        var currentMonth = new Date().getMonth() + 1;
        var currentYear = new Date().getFullYear();
        var filteredDevices = filteredDevices.filter(function(device) {
            var borrowedDate = new Date(device.TGMuon);
            var borrowedMonth = borrowedDate.getMonth() + 1;
            var borrowedYear = borrowedDate.getFullYear();
            return borrowedMonth === parseInt(month) && borrowedYear === currentYear;
        });
    }
    var tbody = document.querySelector('table tbody');
    tbody.innerHTML = '';

    filteredDevices.forEach(function(device) {
        var tr = document.createElement('tr');
        tr.innerHTML = '<td>' + device.maTB + '</td>' +
                       '<td>' + device.name + '</td>' +
                       '<td>' + device.description + '</td>' +
                       '<td>' + device.availability + '</td>'+
                        '<td>' + device.studentId + '</td>';
        tbody.appendChild(tr);
    });
}
fetch('/getThongTinSDList', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    }
})
.then(response => response.json())
.then(data => {
    var thongTinSDList = data.data;
    var tbody = document.querySelector('#checkInList');
    tbody.innerHTML = '';

    thongTinSDList.forEach(function(thongTinSD) {
        var tr = document.createElement('tr');
        tr.innerHTML = '<td>' + thongTinSD.maTV + '</td>' +
                       '<td>' + thongTinSD.tenTV + '</td>' +
                       '<td class="align-middle text-center text-sm">' + thongTinSD.tgVao + '</td>';
        tbody.appendChild(tr);
    });
})
.catch((error) => {
    console.error('Error:', error);
});
document.querySelector('#locVaoKhuHocTap').addEventListener('click', function() {
    var enterFromDate = document.querySelector('#enterFromDate').value;
    var enterToDate = document.querySelector('#enterToDate').value;
    var inputKhoa = document.querySelector('#input-khoa').value;
    var inputNganh = document.querySelector('#input-nganh').value;

    // Convert the date strings to the expected format
    if (enterFromDate) {
        enterFromDate = enterFromDate.replace('T', ' ') + ':00';
    }
    if (enterToDate) {
        enterToDate = enterToDate.replace('T', ' ') + ':00';
    }

    fetch('/filterThongTinSD', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            enterFromDate: enterFromDate,
            enterToDate: enterToDate,
            inputKhoa: inputKhoa,
            inputNganh: inputNganh
        })
    })
    .then(response => response.json())
    .then(data => {
        var thongTinSDList = data.data;
        var tbody = document.querySelector('#checkInList');
        tbody.innerHTML = '';

        thongTinSDList.forEach(function(thongTinSD) {
            var tr = document.createElement('tr');
            tr.innerHTML = '<td>' + thongTinSD.maTV + '</td>' +
                           '<td>' + thongTinSD.tenTV + '</td>' +
                           '<td class="align-middle text-center text-sm">' + thongTinSD.tgVao + '</td>';
            tbody.appendChild(tr);
        });
    })
    .catch((error) => {
        console.error('Error:', error);
    });
});
fetch('/getXuLy', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    }
})
.then(response => response.json())
.then(data => {
    var xuLyList = data.data;
    var tbody = document.getElementById('xuLyList');
    tbody.innerHTML = '';
    var total = 0;
    xuLyList.forEach(function(xuLy) {
        var tr = document.createElement('tr');
        tr.innerHTML = '<td>' + xuLy.maTV + '</td>' +
                       '<td>' + xuLy.tenTV + '</td>' +
                       '<td class="align-middle text-center text-sm">' + xuLy.hinhThuc + '</td>' +
                       '<td class="align-middle text-center text-sm">' + xuLy.soTien + '</td>' +
                       '<td class="align-middle text-center text-sm">' + xuLy.ngayXuLy + '</td>' +
                       '<td class="align-middle text-center text-sm">' + xuLy.trangThai + '</td>';
        tbody.appendChild(tr);
        if(xuLy.soTien !== 'N/A') {
            total += parseInt(xuLy.soTien);
        }
    });
    document.getElementById('totalPrice').textContent = total;
    
    var select = document.getElementById('filterStatus');
    select.addEventListener('change', function() {
        var selectedOption = this.value;
        var rows = tbody.getElementsByTagName('tr');

        for (var i = 0; i < rows.length; i++) {
            var statusCell = rows[i].getElementsByTagName('td')[5]; // Assuming the status is in the 6th column
            if (selectedOption === 'Tất cả' || statusCell.textContent === selectedOption) {
                rows[i].style.display = '';
            } else {
                rows[i].style.display = 'none';
            }
        }
    });
})
.catch((error) => {
    console.error('Error:', error);
});
</script>

</html>